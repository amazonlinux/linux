#!/bin/bash
#
# build up a git repo while appling the fedora kernel patches
# Author: Cristian Gafton <gafton@amazon.com>

trap 'echo "script exited with ERROR: $BASH_COMMAND"' ERR
set -e -x

DEFAULT_AUTHOR="RPM Patch <kernel@fedoraproject.org>"

LINUX_DIR=@@LINUX_DIR@@
VTAG=@@VTAG@@
TAGVER=@@TAGVER@@
UPSTREAM=@@UPSTREAM@@

PATCH_ARGS=
FINISH=
while [ $# -gt 0 ] ; do
    case $1 in
        -p* | -F* | -R ) PATCH_ARGS="$PATCH_ARGS $1" ;;
        --finish ) FINISH=$1 ;;
        * ) echo "Ignoring patch option: $1" ;;
    esac
    shift
done

# defines we will capture later in the linux.vars file
BRANCH="${UPSTREAM}/${TAGVER}"
TAG="${UPSTREAM}/${TAGVER}/start"

function init_tree {
    # clone out the stable linux tree
    local b=$(basename $(pwd -P))
    pushd ..
    rm -rf $b.git
    git clone --no-hardlinks $LINUX_DIR $b.git
    cd $b.git
    git checkout -b $BRANCH $VTAG
    popd
    # now bring over changes from the unpacked tree
    rsync -aH --delete-after ../$b.git/.git/ ./.git/
    rm -rf ../$b.git
    # now add the changes done by our unpacking...
    git add .
    git commit --quiet --allow-empty -m "start import into $branch"
    git tag $TAG
}

function clean_tree {
    if [ ! -d .git ] ; then
        init_tree
    fi
    git clean -fdx
}

function commit_tree {
    local msg=${1:-"added patch from stdin"}
    # try to figure out what the patch did...
    git add .
    # also marked as removed in git the stuff that was removed...
    git status --short | grep -E '^.?D' | awk '{print $2}' | xargs -r git rm
    local z=$(git status --short)
    local phead=
    if [ -n "$ptmp" ] ; then
        phead=$(sed -n -r -e '0,/^(--$|diff -|--- )/p;' <$ptmp | \
            sed -r -e 's/^(.*)$/#    \1/')
    fi
    if [ -n "${z}" ] ; then 
        cat <<EOF | git commit -s --author="$DEFAULT_AUTHOR" --file=-
${msg}

$(git diff --cached --stat)
${phead}
EOF
    fi
}

function commit_tree_wrap {
    local msg=$1
    if [ $(git status --short|wc -l) -gt 0 ] ; then
        commit_tree "${msg}"
    fi
}

if [ -n "$FINISH" ] ; then
    ptmp=
    topdir=$(git rev-parse --show-toplevel)
    pushd linux-${VTAG##v}* && \
        commit_tree_wrap "finalized prep"
    clean_tree
    # generate the linux.vers file
    popd
    echo "Updating the linux.vers file..."
    cat >${topdir}/linux.vers <<EOF
linux_TAGVER	= ${VTAG##v}
linux_BASE	= ${TAG}
linux_BRANCH	= ${BRANCH}
linux_HEAD	= $$(linux_BRANCH)
EOF
    exit 0
fi

# capture the stdin into a temp file
ptmp=$(mktemp $RPM_SOURCE_DIR/pXXXXXX)
trap "rm -f $ptmp" 0 9 15
sed -e '/\S/,$!d;' >$ptmp

# attempt to save the state of tree changes done via non-patch actions (such
# as copying stuff in between patches, etc)
if [ -d .git ] ; then
    commit_tree_wrap "pre-patch tree changes $patch"
else
    clean_tree
fi

if [ -n "$patch" ] ; then
    if ! git am $ptmp ; then
        if [ -d .git/rebase-apply ] ; then
            git am --abort
        fi
        git clean -fdx
        /usr/bin/patch $PATCH_ARGS <$ptmp
        commit_tree "imported patch: $patch"
    fi
else
    /usr/bin/patch $PATCH_ARGS <$ptmp
    commit_tree
fi
rm -f $ptmp
clean_tree
